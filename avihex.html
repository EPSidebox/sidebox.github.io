<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AVI HEX FRAME EDITOR | Glitch Pedagogy Tool</title>
  <meta name="author" content="Ernesto Pe√±a">
  <meta name="description" content="Frame-by-frame hex editing tool for AVI video databending and glitch art creation with multi-byte selection, pattern corruption, and datamosh operations.">
  <meta name="citation_author" content="Pe√±a, Ernesto">
  <meta name="citation_title" content="AVI Hex Frame Editor: A Glitch Pedagogy Tool">
  <meta name="citation_date" content="2025">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-8XQLL5N022"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-8XQLL5N022');
  </script>
  <style>
    /* === BASE RESET === */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* === TYPOGRAPHY & COLORS === */
    :root {
      --font: 'Roboto Mono', monospace;
      --bg: #0a0a0a;
      --text: #e0e0e0;
      --accent: #FF00FF;
      --accent-secondary: #00bcd4;
      --accent-tertiary: #8bc34a;
      --accent-warning: #ff9800;
      --muted: #666;
      --border: #222;
      --panel-bg: #111;
      --hover-bg: #1a1a1a;
      --hover-text: #fff;
      --input-bg: #1a1a1a;
      --hex-bg: #000;
      --chart-grid: #222;
      --chart-tick: #666;
    }
    
    [data-theme="light"] {
      --bg: #ffffff;
      --text: #000000;
      --accent: #FF00FF;
      --accent-secondary: #00bcd4;
      --accent-tertiary: #8bc34a;
      --accent-warning: #ff9800;
      --muted: #666666;
      --border: #e0e0e0;
      --panel-bg: #f5f5f5;
      --hover-bg: #e8e8e8;
      --hover-text: #000;
      --input-bg: #f8f8f8;
      --hex-bg: #fafafa;
      --chart-grid: #e0e0e0;
      --chart-tick: #999;
    }
    
    body {
      font-family: 'Roboto Mono', monospace;
      background: var(--bg);
      color: var(--text);
      padding: clamp(1rem, 1rem + ((1vw - 0.48rem) * 0.288), 1.125rem);
      line-height: 1.6;
      font-size: clamp(0.875rem, 0.875rem + ((1vw - 0.48rem) * 0.288), 1rem);
    }
    
    header {
      margin-bottom: clamp(1rem, 1rem + ((1vw - 0.48rem) * 0.288), 1.125rem);
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .header-content { flex: 1; min-width: 200px; }
    
    h1 {
      color: var(--accent);
      font-size: clamp(1.75rem, 1.75rem + ((1vw - 0.48rem) * 0.288), 1.875rem);
      margin-bottom: 2px;
      font-weight: 400;
      line-height: 1.2;
    }
    
    .subtitle {
      color: var(--muted);
      font-size: clamp(0.875rem, 0.875rem + ((1vw - 0.48rem) * 0.144), 0.9375rem);
      line-height: 1.5;
    }
    
    .theme-toggle {
      padding: 6px 12px;
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      cursor: pointer;
      font-family: inherit;
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .theme-toggle:hover {
      border-color: var(--accent);
      background: var(--hover-bg);
    }
    
    .theme-toggle:focus {
      outline: 2px dashed var(--accent);
      outline-offset: 2px;
    }
    
    .upload-btn {
      display: inline-block;
      padding: 11px 22px;
      background: var(--hover-bg);
      border: 2px solid var(--accent);
      border-radius: 4px;
      color: var(--accent);
      cursor: pointer;
      font-family: inherit;
      font-size: clamp(0.75rem, 0.75rem + ((1vw - 0.48rem) * 0.144), 0.8125rem);
      transition: all 0.15s;
    }
    
    .upload-btn:hover {
      background: var(--accent);
      color: var(--bg);
    }
    
    .upload-btn:focus {
      outline: 2px dashed var(--accent);
      outline-offset: 2px;
    }
    
    .panel {
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 1.5rem;
    }
    
    .panel-title {
      color: var(--accent);
      font-size: clamp(0.75rem, 0.75rem + ((1vw - 0.48rem) * 0.144), 0.8125rem);
      margin-bottom: 8px;
      font-weight: bold;
      line-height: 1.4;
    }
    
    .ctrl-row {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    .ctrl-btn {
      padding: 5px 9px;
      background: var(--hover-bg);
      border: 1px solid #444;
      border-radius: 3px;
      color: var(--text);
      cursor: pointer;
      font-family: inherit;
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
      transition: all 0.15s;
    }
    
    .ctrl-btn:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .ctrl-btn:focus {
      outline: 2px dashed var(--accent);
      outline-offset: 2px;
    }
    
    .ctrl-btn:active:not(:disabled) {
      transform: scale(0.98);
    }
    
    .ctrl-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg);
    }
    
    .ctrl-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .info-box {
      padding: 8px;
      background: var(--panel-bg);
      border-radius: 4px;
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
      border-left: 2px solid var(--accent);
      line-height: 1.5;
    }
    
    .timeline {
      height: 70px;
      background: var(--hover-bg);
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      display: block;
      transition: all 0.15s;
    }
    
    .timeline:hover {
      background: var(--panel-bg);
    }
    
    .hex-container {
      background: var(--hex-bg);
      color: var(--text);
      padding: 12px;
      border-radius: 4px;
      font-family: 'Roboto Mono', monospace;
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
      overflow: auto;
      max-height: calc(100vh - 340px);
      border: 1px solid var(--border);
    }
    
    .hex-row {
      display: flex;
      gap: 12px;
      margin-bottom: 3px;
      padding: 2px 0;
      transition: background 0.15s;
    }
    
    .hex-row:hover {
      background: var(--hover-bg);
    }
    
    .hex-offset {
      color: var(--muted);
      width: 70px;
    }
    
    .hex-bytes {
      display: flex;
      gap: 3px;
    }
    
    .hex-byte {
      width: 20px;
      text-align: center;
      background: transparent;
      border: none;
      color: var(--text);
      font-family: inherit;
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
      cursor: pointer;
      padding: 0;
      transition: all 0.15s;
    }
    
    .hex-byte:hover {
      background: var(--hover-bg);
    }
    
    .hex-byte:focus {
      outline: 1px solid var(--accent);
      background: var(--hover-bg);
    }
    
    .hex-byte.selected {
      background: var(--accent);
      color: var(--bg);
      font-weight: bold;
    }
    
    .hex-byte-protected {
      background: var(--panel-bg) !important;
      color: var(--muted) !important;
      cursor: not-allowed !important;
      opacity: 0.6;
    }
    
    .hex-ascii {
      color: var(--muted);
      margin-left: 8px;
    }
    
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 6px 8px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 3px;
      color: var(--text);
      font-family: inherit;
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
      transition: all 0.15s;
    }
    
    input[type="text"]:hover,
    input[type="number"]:hover,
    select:hover {
      border-color: var(--accent);
    }
    
    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--hover-bg);
    }
    
    .field-group {
      margin-bottom: 10px;
    }
    
    .field-label {
      display: block;
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
      color: var(--muted);
      margin-bottom: 4px;
      line-height: 1.4;
    }
    
    .radio-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 8px 0;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
      cursor: pointer;
      transition: color 0.15s;
    }
    
    .radio-option:hover {
      color: var(--accent);
    }
    
    .radio-option input[type="radio"] {
      cursor: pointer;
      accent-color: var(--accent);
    }
    
    .stat-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
    }
    
    .stat-item {
      background: var(--hover-bg);
      padding: 6px 8px;
      border-radius: 3px;
      transition: all 0.15s;
    }
    
    .stat-item:hover {
      background: var(--panel-bg);
    }
    
    .stat-item strong {
      color: var(--accent);
    }
    
    .badge {
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
      padding: 2px 6px;
      border-radius: 3px;
      background: #333;
      color: #888;
      transition: all 0.15s;
    }
    
    .badge.warn {
      background: rgba(255, 152, 0, 0.2);
      color: var(--accent-warning);
      border: 1px solid var(--accent-warning);
    }
    
    .badge.safe {
      background: rgba(139, 195, 74, 0.2);
      color: var(--accent-tertiary);
      border: 1px solid var(--accent-tertiary);
    }
    
    .badge.i-frame {
      background: rgba(255, 0, 255, 0.2);
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    
    .badge.p-frame {
      background: rgba(0, 188, 212, 0.2);
      color: var(--accent-secondary);
      border: 1px solid var(--accent-secondary);
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    
    .tools-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    
    @media (max-width: 1150px) {
      .main-grid,
      .tools-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .legend {
      display: flex;
      gap: 12px;
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
      margin-top: 6px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }
    
    .legend-dot.i-frame {
      background: var(--accent);
    }
    
    .legend-dot.p-frame {
      background: var(--accent-secondary);
    }
    
    .datamosh-warning {
      background: rgba(255, 152, 0, 0.1);
      border: 1px solid var(--accent-warning);
      color: var(--accent-warning);
      padding: 8px;
      border-radius: 4px;
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
      margin-top: 8px;
      line-height: 1.4;
    }
    
    [data-tooltip] {
      position: relative;
    }
    
    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--hover-bg);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 4px;
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
      white-space: nowrap;
      border: 1px solid var(--accent);
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      animation: tooltipFadeIn 0.2s ease-in-out 1.5s forwards;
    }
    
    [data-tooltip]:hover::before {
      content: '';
      position: absolute;
      bottom: calc(100% + 2px);
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--accent);
      z-index: 1001;
      pointer-events: none;
      opacity: 0;
      animation: tooltipFadeIn 0.2s ease-in-out 1.5s forwards;
    }
    
    @keyframes tooltipFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    footer {
      margin-top: clamp(1.5rem, 1.5rem + ((1vw - 0.48rem) * 1.442), 2rem);
      padding-top: 14px;
      border-top: 1px solid var(--border);
      font-size: clamp(0.625rem, 0.625rem + ((1vw - 0.48rem) * 0.072), 0.6563rem);
      color: var(--muted);
      text-align: center;
      line-height: 1.6;
    }
    
    footer a {
      color: var(--accent);
      text-decoration: underline;
      transition: all 0.15s;
    }
    
    footer a:hover {
      text-decoration: none;
      color: var(--hover-text);
    }
    
    footer a:focus {
      text-decoration: underline dashed;
      outline: 2px dashed var(--accent);
      outline-offset: 2px;
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>AVI Hex Frame Editor</h1>
      <p class="subtitle">Frame-by-frame hex editing ‚Ä¢ Multi-byte selection ‚Ä¢ Datamosh operations ‚Ä¢ Use with VLC for preview</p>
    </div>
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
      <span id="themeIcon">‚òÄÔ∏è</span>
      <span id="themeText">Light</span>
    </button>
  </header>

  <div style="display:flex;justify-content:flex-end;margin-bottom:16px">
    <label class="upload-btn"><input type="file" accept=".avi" id="fileInput" style="display:none">Choose AVI File</label>
  </div>

  <div id="tutorial" class="panel">
    <div class="panel-title">Getting Started</div>
    <div style="font-size:0.72rem;line-height:1.6;color:var(--text)">
      <p style="margin-bottom:12px">This tool allows you to manipulate AVI video files at the byte level while protecting critical file structures. Perfect for databending and glitch art experimentation.</p>
      
      <p style="margin-bottom:8px;color:var(--accent);font-weight:bold">Quick Start:</p>
      <ol style="margin-left:20px;margin-bottom:12px">
        <li style="margin-bottom:6px"><strong>Load:</strong> Click "Choose AVI File" to load your video</li>
        <li style="margin-bottom:6px"><strong>Select:</strong> Click bytes in the hex view, use Find, or select by column/row</li>
        <li style="margin-bottom:6px"><strong>Scope:</strong> Choose which frames to affect (Current, All, or Range) and step pattern</li>
        <li style="margin-bottom:6px"><strong>Action:</strong> Apply hex transformations or datamosh operations</li>
        <li style="margin-bottom:6px"><strong>Export:</strong> Download your glitched video and preview in VLC</li>
      </ol>
      
      <p style="margin-bottom:8px;color:var(--accent);font-weight:bold">Key Features:</p>
      <ul style="margin-left:20px;margin-bottom:12px">
        <li style="margin-bottom:4px"><strong>Frame Type Detection:</strong> Automatically classifies frames as I-frames (large) or P-frames (small)</li>
        <li style="margin-bottom:4px"><strong>Datamosh Operations:</strong> Delete/duplicate I/P frames with precise scope control</li>
        <li style="margin-bottom:4px"><strong>Frame Type Scopes:</strong> Apply operations to only I-frames or only P-frames across entire video</li>
        <li style="margin-bottom:4px"><strong>Protected Headers:</strong> File and frame headers are protected by default (click badge to toggle)</li>
        <li style="margin-bottom:4px"><strong>Multi-byte Search:</strong> Find multiple patterns at once: "FB00, F3, DB0033"</li>
        <li style="margin-bottom:4px"><strong>Value Proximity:</strong> Select bytes near your selection's values (¬±3 default)</li>
        <li style="margin-bottom:4px"><strong>Step Control:</strong> Apply to every frame or every nth frame</li>
        <li style="margin-bottom:4px"><strong>Timeline Visualization:</strong> See frame types and selection patterns across timeline</li>
      </ul>
      
      <p style="font-size:0.65rem;color:var(--muted);margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
        <strong>Tip:</strong> Start with small changes on a few frames. Use Undo (‚Ü∂) liberally. The frequency chart shows byte distribution changes.
      </p>
    </div>
  </div>

  <div id="controls" class="hidden">
    <div class="ctrl-row" style="margin-bottom:8px">
      <span id="fileName" style="color:var(--muted);font-size:0.72rem;flex:1"></span>
      <button class="ctrl-btn" id="undoBtn" disabled data-tooltip="Undo last change (Ctrl+Z)">‚Ü∂</button>
      <button class="ctrl-btn" id="redoBtn" disabled data-tooltip="Redo (Ctrl+Y)">‚Ü∑</button>
      <button class="ctrl-btn" id="resetBtn" data-tooltip="Reset to original file">‚Ü∫</button>
      <button class="ctrl-btn active" id="downloadBtn" data-tooltip="Export modified AVI">‚¨á Export</button>
    </div>
    <div id="changeCount" style="font-size:0.65rem;color:var(--muted);margin-bottom:14px">No changes</div>
  </div>

  <div id="content" class="hidden">
    <div class="panel">
      <div class="panel-title">Timeline</div>
      <canvas id="timeline" class="timeline"></canvas>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot i-frame"></div>I-Frame (large)</div>
        <div class="legend-item"><div class="legend-dot p-frame"></div>P-Frame (small)</div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
        <div class="ctrl-row" style="margin:0">
          <button class="ctrl-btn" id="playBtn" data-tooltip="Play/Pause">‚ñ∂</button>
          <button class="ctrl-btn" id="stepBackBtn" data-tooltip="Previous frame">‚Üê</button>
          <button class="ctrl-btn" id="stepBtn" data-tooltip="Next frame">‚Üí</button>
          <button class="ctrl-btn" id="rewindBtn" data-tooltip="Jump to frame 0">‚Ü∫</button>
        </div>
        <input type="number" id="frameInput" min="0" max="0" value="0" style="width:60px;padding:4px">
        <span style="font-size:0.65rem;color:var(--muted)" id="timeDisplay">00:00:000</span>
        <div style="flex:1"></div>
        <div class="stat-row" style="gap:8px;grid-template-columns:auto auto">
          <div class="stat-item">Total: <strong id="totalFrames">0</strong></div>
          <div class="stat-item">Video: <strong id="videoFrames">0</strong></div>
        </div>
      </div>
    </div>

    <div class="main-grid">
      <div>
        <div class="panel">
          <div class="panel-title" style="display:flex;justify-content:space-between">
            <span>Hex Editor <span style="font-weight:normal;font-size:0.7rem" id="hexTitle"></span></span>
            <span class="badge warn" id="protectionBadge" onclick="toggleFrameProtection()" style="cursor:pointer;user-select:none">‚ö† Protected</span>
          </div>
          <div class="hex-container" id="hexView"></div>
          <div style="font-size:0.6rem;color:var(--muted);margin-top:8px">Click: select ‚Ä¢ Shift: add ‚Ä¢ Ctrl: toggle</div>
        </div>
      </div>

      <div>
        <div class="panel">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
            <div>
              <div class="panel-title" style="margin-bottom:8px">Frame Info</div>
              <div id="frameInfo" style="font-size:0.65rem;color:var(--muted);line-height:1.5">No frame loaded</div>
            </div>
            <div>
              <div class="panel-title" style="margin-bottom:8px">Selection Stats</div>
              <div id="selectionStats" style="font-size:0.6rem;line-height:1.4;color:var(--muted)">No selection</div>
            </div>
          </div>
          <div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border)">
            <div class="panel-title" style="margin-bottom:8px">Frame Analysis</div>
            <div id="frameTypeStats" style="font-size:0.65rem;color:var(--muted);line-height:1.5">Analyzing...</div>
          </div>
          <div>
            <div class="panel-title" style="margin-bottom:8px">Byte Frequency Distribution</div>
            <div style="height:150px;position:relative">
              <canvas id="frequencyChart"></canvas>
            </div>
          </div>
        </div>

        <div class="tools-grid">
          <div>
            <div class="panel">
              <div class="panel-title">1. SELECTION</div>
              <div class="field-label" style="margin-bottom:6px">Find & Select</div>
              <div style="display:grid;grid-template-columns:1fr auto;gap:6px;margin-bottom:10px">
                <input type="text" id="findInput" placeholder="FB00, F3, DB0033">
                <button class="ctrl-btn" onclick="findAndSelect()" data-tooltip="Find hex patterns (comma-separated)">Find</button>
              </div>
              <div class="field-label" style="margin-bottom:6px">Select Bytes</div>
              <div class="ctrl-row" style="margin:0 0 6px 0;align-items:center">
                <button class="ctrl-btn" onclick="selectColumn()" data-tooltip="Select entire column(s)">‚Üï</button>
                <button class="ctrl-btn" onclick="selectRow()" data-tooltip="Select entire row(s)">‚Üî</button>
                <button class="ctrl-btn" onclick="expandSelection()" data-tooltip="Expand selection outward">+</button>
                <button class="ctrl-btn" onclick="shrinkSelection()" data-tooltip="Shrink selection inward">‚àí</button>
                <input type="number" id="proximityTolerance" value="3" min="1" max="128" placeholder="¬±" style="flex:1;padding:4px 6px">
                <button class="ctrl-btn" onclick="selectByValueProximity()" data-tooltip="Select bytes near current values">¬± Range</button>
                <button class="ctrl-btn" onclick="clearSelection()" data-tooltip="Clear all selection">‚úï</button>
              </div>
              <div id="selectionInfo" style="font-size:0.6rem;color:var(--muted);margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">No selection</div>
            </div>

            <div class="panel">
              <div class="panel-title">2. SCOPE</div>
              <div class="field-label" style="margin-bottom:4px">Scope</div>
              <div class="radio-group" style="margin:0 0 10px 0">
                <label class="radio-option">
                  <input type="radio" name="frameRange" value="current" checked onchange="updateRangeMode()">Current
                </label>
                <label class="radio-option">
                  <input type="radio" name="frameRange" value="all" onchange="updateRangeMode()">All
                </label>
                <label class="radio-option">
                  <input type="radio" name="frameRange" value="custom" onchange="updateRangeMode()">Range
                </label>
                <label class="radio-option">
                  <input type="radio" name="frameRange" value="iframes" onchange="updateRangeMode()">I-Frames
                </label>
                <label class="radio-option">
                  <input type="radio" name="frameRange" value="pframes" onchange="updateRangeMode()">P-Frames
                </label>
              </div>
              <div class="field-label" style="margin-bottom:4px">Step</div>
              <div class="radio-group" style="margin:0">
                <label class="radio-option">
                  <input type="radio" name="frameStep" value="every" checked onchange="updateRangeMode()">Every frame
                </label>
                <label class="radio-option">
                  <input type="radio" name="frameStep" value="nth" onchange="updateRangeMode()">Every
                  <input type="number" id="nthFrameInput" min="1" value="2" style="width:40px;padding:2px 4px" onchange="updateRangeMode()">th frame
                </label>
              </div>
              <div id="customRangeDisplay" class="hidden" style="margin-top:8px;padding:8px;background:var(--panel-bg);border-radius:4px;font-size:0.6rem">
                <span style="color:var(--accent)">Frame <span id="rangeStartDisplay">0</span>-<span id="rangeEndDisplay">0</span></span>
              </div>
            </div>
          </div>

          <div>
            <div class="panel">
              <div class="panel-title">3. ACTION</div>
              <div class="field-label" style="margin-bottom:6px">Hex area</div>
              <div class="ctrl-row" style="margin:0 0 10px 0;align-items:center">
                <button class="ctrl-btn" onclick="deleteSelection()" data-tooltip="Zero out selected bytes">00</button>
                <button class="ctrl-btn" onclick="invertSelection()" data-tooltip="Invert byte values (255-value)">‚áÑ</button>
                <button class="ctrl-btn" onclick="randomizeSelection()" data-tooltip="Randomize selected bytes">üé≤</button>
                <input type="text" id="setValueInput" placeholder="Hex" maxlength="2" style="flex:1;padding:4px 6px">
                <button class="ctrl-btn" onclick="setSelectionValue()" data-tooltip="Set selection to hex value">Set</button>
              </div>
              <div class="field-label" style="margin-bottom:6px;padding-top:8px;border-top:1px solid var(--border)">Datamosh</div>
              <div class="ctrl-row" style="margin:0 0 10px 0">
                <button class="ctrl-btn" id="deleteIFramesBtn" disabled data-tooltip="Remove I-frames in scope for pixel drag">‚úñ I-F</button>
                <button class="ctrl-btn" id="duplicatePFramesBtn" disabled data-tooltip="Duplicate P-frames in scope for bloom">2√ó P-F</button>
                <button class="ctrl-btn" id="deleteCurrentBtn" disabled data-tooltip="Remove current frame">‚úñ Current</button>
              </div>
              <div class="datamosh-warning hidden" id="datamoshWarning" style="margin-bottom:10px"></div>
              <div class="field-label" style="margin-bottom:6px;padding-top:8px;border-top:1px solid var(--border)">Advanced</div>
              <div class="field-group">
                <label class="field-label">Gradient</label>
                <div style="display:grid;grid-template-columns:1fr 1fr auto auto;gap:4px">
                  <input type="text" id="gradStart" placeholder="00" maxlength="2">
                  <input type="text" id="gradEnd" placeholder="FF" maxlength="2">
                  <button class="ctrl-btn" onclick="gradientFill('relative')" data-tooltip="Gradient within each frame">REL</button>
                  <button class="ctrl-btn" onclick="gradientFill('absolute')" data-tooltip="Gradient across all frames">ABS</button>
                </div>
              </div>
              <div class="field-group">
                <label class="field-label">Pattern</label>
                <div style="display:grid;grid-template-columns:1fr auto;gap:6px">
                  <input type="text" id="patternInput" placeholder="FF 00">
                  <button class="ctrl-btn" onclick="patternFill()" data-tooltip="Fill with repeating pattern">Fill</button>
                </div>
              </div>
              <div class="field-group">
                <label class="field-label">Shift</label>
                <div style="display:grid;grid-template-columns:1fr auto auto;gap:4px">
                  <input type="number" id="shiftAmount" value="16" min="-255" max="255">
                  <button class="ctrl-btn" onclick="shiftSelection(-1)" data-tooltip="Subtract value from bytes">‚àí</button>
                  <button class="ctrl-btn" onclick="shiftSelection(1)" data-tooltip="Add value to bytes">+</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    AVI Hex Frame Editor ‚Äî Glitch Pedagogy Tool<br>
    Ernesto Pe√±a | <a href="https://ernestopena.com">ernestopena.com</a>
  </footer>

  <script>
    let aviData=null,frames=[],currentFrame=0,hexData=null,selectedBytes=new Set();
    let originalFileName='',videoBlob=null,customRangeStart=0,customRangeEnd=0,draggingHandle=null;
    let protectedHeaderEnd=0,originalBytes=null,undoStack=[],redoStack=[];
    let isPlaying=false,playbackInterval=null;
    let frameProtectionEnabled=true,currentFrameProtectionEnd=0;
    let frequencyChart=null;
    let frameTypeThreshold=0;

    // === THEME TOGGLE ===
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');
    const html = document.documentElement;
    
    const getPreferredTheme = () => {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) return savedTheme;
      return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
    };
    
    const setTheme = (theme) => {
      if (theme === 'light') {
        html.setAttribute('data-theme', 'light');
        themeIcon.textContent = 'üåô';
        themeText.textContent = 'Dark';
      } else {
        html.removeAttribute('data-theme');
        themeIcon.textContent = '‚òÄÔ∏è';
        themeText.textContent = 'Light';
      }
      localStorage.setItem('theme', theme);
      if(frames.length)drawTimeline();
      if(frequencyChart){
        const gridColor=theme==='light'?'#e0e0e0':'#222';
        const tickColor=theme==='light'?'#999':'#666';
        frequencyChart.options.scales.y.grid.color=gridColor;
        frequencyChart.options.scales.y.ticks.color=tickColor;
        frequencyChart.update('none');
      }
    };
    
    setTheme(getPreferredTheme());
    
    themeToggle.addEventListener('click', () => {
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      setTheme(newTheme);
    });
    
    window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
      if (!localStorage.getItem('theme')) {
        setTheme(e.matches ? 'light' : 'dark');
      }
    });

    document.getElementById('fileInput').addEventListener('change',e=>{
      const file=e.target.files[0];
      if(!file)return;
      originalFileName=file.name;
      document.getElementById('fileName').textContent=file.name;
      const reader=new FileReader();
      reader.onload=ev=>{
        try{
          const buf=ev.target.result;
          const view=new DataView(buf);
          const bytes=new Uint8Array(buf);
          if(String.fromCharCode(...bytes.slice(0,4))!=='RIFF')return alert('Not AVI');
          if(String.fromCharCode(...bytes.slice(8,12))!=='AVI ')return alert('Not AVI');
          let pos=12,moviStart=null,moviSize=0;
          while(pos<bytes.length-8){
            const id=String.fromCharCode(...bytes.slice(pos,pos+4));
            const sz=view.getUint32(pos+4,true);
            if(id==='movi'){moviStart=pos+8;moviSize=sz;break;}
            if(id==='LIST'&&String.fromCharCode(...bytes.slice(pos+8,pos+12))==='movi'){moviStart=pos+12;moviSize=sz-4;break;}
            const next=pos+8+sz+(sz%2);
            if(next<=pos||sz>bytes.length)break;
            pos=next;
          }
          if(!moviStart)return alert('No movi');
          const foundFrames=[];
          pos=moviStart;
          let fi=0;
          while(pos<moviStart+moviSize-8&&pos<bytes.length-8){
            const id=String.fromCharCode(...bytes.slice(pos,pos+4));
            const sz=view.getUint32(pos+4,true);
            if(id.match(/^\d{2}(db|dc|wb)/i)){
              foundFrames.push({index:fi++,type:id,offset:pos,dataOffset:pos+8,size:sz,
                isVideo:id.toLowerCase().endsWith('db')||id.toLowerCase().endsWith('dc')});
            }
            const next=pos+8+sz+(sz%2);
            if(next<=pos)break;
            pos=next;
          }
          aviData={bytes,frames:foundFrames,headerEnd:moviStart};
          frames=foundFrames;
          protectedHeaderEnd=moviStart;
          originalBytes=new Uint8Array(bytes);
          undoStack=[];redoStack=[];
          
          analyzeFrameTypes();
          
          if(frames.length>0){
            customRangeStart=0;customRangeEnd=frames.length-1;
            currentFrame=0;loadFrameHex(0);
            document.getElementById('tutorial').classList.add('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('frameInput').max=frames.length-1;
            document.getElementById('totalFrames').textContent=frames.length;
            document.getElementById('videoFrames').textContent=frames.filter(f=>f.isVideo).length;
            initFrequencyChart();
            updateRangeDisplay();updateFrameInfo();drawTimeline();updateChangeCount();
            document.getElementById('undoBtn').disabled=true;
            document.getElementById('redoBtn').disabled=true;
          }
        }catch(err){alert('Parse error: '+err.message);}
      };
      reader.readAsArrayBuffer(file);
    });

    function analyzeFrameTypes(){
      if(!frames.length)return;
      
      const videoFrames=frames.filter(f=>f.isVideo);
      if(videoFrames.length===0)return;
      
      const sizes=videoFrames.map(f=>f.size);
      const avgSize=sizes.reduce((a,b)=>a+b,0)/sizes.length;
      const sortedSizes=[...sizes].sort((a,b)=>a-b);
      const median=sortedSizes[Math.floor(sortedSizes.length/2)];
      
      const variance=sizes.reduce((sum,size)=>sum+Math.pow(size-avgSize,2),0)/sizes.length;
      const stdDev=Math.sqrt(variance);
      
      frameTypeThreshold=median+stdDev*0.5;
      
      let iCount=0,pCount=0;
      frames.forEach(f=>{
        if(f.isVideo){
          f.frameType=f.size>=frameTypeThreshold?'I':'P';
          if(f.frameType==='I')iCount++;else pCount++;
        }else{
          f.frameType='audio';
        }
      });
      
      const stats=`${iCount} I-frames (large), ${pCount} P-frames (small) ‚Ä¢ Threshold: ${(frameTypeThreshold/1024).toFixed(1)}KB`;
      document.getElementById('frameTypeStats').textContent=stats;
      
      document.getElementById('deleteIFramesBtn').disabled=false;
      document.getElementById('duplicatePFramesBtn').disabled=false;
      document.getElementById('deleteCurrentBtn').disabled=false;
    }

    function loadFrameHex(fi){
      if(!aviData||!frames[fi])return;
      const f=frames[fi];
      hexData=aviData.bytes.slice(f.dataOffset,f.dataOffset+f.size);
      currentFrameProtectionEnd=0;
      if(frameProtectionEnabled&&f.isVideo){
        for(let i=0;i<hexData.length-1;i++){
          if(hexData[i]===0xFF&&hexData[i+1]===0xDA){
            currentFrameProtectionEnd=i+2;
            break;
          }
        }
      }
      selectedBytes.clear();renderHex();updateSelectionInfo();updateProtectionBadge();updateFrequencyChart();
    }

    function initFrequencyChart(){
      const ctx=document.getElementById('frequencyChart').getContext('2d');
      const isDark=!html.getAttribute('data-theme');
      frequencyChart=new Chart(ctx,{
        type:'line',
        data:{
          labels:Array.from({length:256},(_,i)=>'0x'+i.toString(16).padStart(2,'0').toUpperCase()),
          datasets:[{
            label:'Frequency',
            data:new Array(256).fill(0),
            fill:true,
            backgroundColor:'rgba(255,0,255,0.2)',
            borderColor:'#FF00FF',
            borderWidth:1,
            pointRadius:0,
            tension:0.1
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{display:false},
            tooltip:{
              callbacks:{
                title:items=>items[0].label,
                label:item=>{
                  const total=frequencyChart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                  const pct=total>0?((item.raw/total)*100).toFixed(2):0;
                  return item.label+': '+pct+'%';
                }
              }
            }
          },
          scales:{
            x:{display:false},
            y:{
              display:true,
              grid:{color:isDark?'#222':'#e0e0e0'},
              ticks:{color:isDark?'#666':'#999',font:{size:10}}
            }
          }
        }
      });
    }

    function updateFrequencyChart(){
      if(!frequencyChart||!hexData)return;
      
      const rt=document.querySelector('input[name="frameRange"]:checked')?.value;
      const frameList=getFrameList();
      const freq=new Array(256).fill(0);
      
      if(rt==='current'){
        for(let i=0;i<hexData.length;i++){freq[hexData[i]]++;}
      }else{
        for(const fi of frameList){
          const frame=frames[fi];
          const frameData=aviData.bytes.slice(frame.dataOffset,frame.dataOffset+frame.size);
          for(let i=0;i<frameData.length;i++){freq[frameData[i]]++;}
        }
      }
      
      frequencyChart.data.datasets[0].data=freq;
      frequencyChart.update('none');
    }

    function updateSelectionStats(){
      if(!selectedBytes.size){
        document.getElementById('selectionStats').innerHTML='<span style="color:var(--muted)">No selection</span>';
        return;
      }
      
      const selectionData=[];
      Array.from(selectedBytes).forEach(idx=>{
        if(idx<hexData.length)selectionData.push({position:idx,value:hexData[idx]});
      });
      
      const valueFreq={};
      selectionData.forEach(s=>{valueFreq[s.value]=(valueFreq[s.value]||0)+1;});
      
      const rt=document.querySelector('input[name="frameRange"]:checked')?.value;
      const frameList=getFrameList();
      let totalMatches=0,frameMatchCounts=[];
      
      for(const fi of frameList){
        const frame=frames[fi];
        const frameData=aviData.bytes.slice(frame.dataOffset,frame.dataOffset+frame.size);
        let matchCount=0;
        selectionData.forEach(sel=>{
          if(sel.position<frameData.length&&frameData[sel.position]===sel.value)matchCount++;
        });
        if(matchCount>0){
          frameMatchCounts.push(matchCount);
          totalMatches+=matchCount;
        }
      }
      
      const avgPerFrame=frameMatchCounts.length>0?(totalMatches/frameMatchCounts.length).toFixed(1):0;
      let html=`<div style="color:var(--accent-secondary)">${selectedBytes.size} bytes</div>`;
      const uniqueVals=Object.keys(valueFreq).length;
      if(uniqueVals<=3){
        Object.entries(valueFreq).forEach(([val,count])=>{
          html+=`<div>0x${parseInt(val).toString(16).padStart(2,'0').toUpperCase()}: ${count}x</div>`;
        });
      }
      html+=`<div style="margin-top:4px;padding-top:4px;border-top:1px solid var(--border);color:var(--muted)">`;
      html+=`<div>${totalMatches} matches</div>`;
      html+=`<div>${frameMatchCounts.length} frames</div>`;
      html+=`<div>Avg: ${avgPerFrame}/frame</div>`;
      html+='</div>';
      document.getElementById('selectionStats').innerHTML=html;
    }

    function selectByValueProximity(){
      if(!selectedBytes.size)return alert('Select byte(s) first');
      const tolerance=parseInt(document.getElementById('proximityTolerance').value)||3;
      
      const selectedValues=new Set();
      Array.from(selectedBytes).forEach(idx=>{
        if(idx<hexData.length)selectedValues.add(hexData[idx]);
      });
      
      const valueRanges=[];
      selectedValues.forEach(val=>{
        const min=Math.max(0,val-tolerance);
        const max=Math.min(255,val+tolerance);
        valueRanges.push({min,max});
      });
      
      const rt=document.querySelector('input[name="frameRange"]:checked').value;
      const frameList=getFrameList();
      let totalAdded=0;
      
      if(rt==='current'){
        const f=frames[currentFrame];
        for(let i=0;i<hexData.length;i++){
          if(f.dataOffset+i<protectedHeaderEnd)continue;
          if(frameProtectionEnabled&&i<currentFrameProtectionEnd)continue;
          const val=hexData[i];
          const inRange=valueRanges.some(r=>val>=r.min&&val<=r.max);
          if(inRange&&!selectedBytes.has(i)){
            selectedBytes.add(i);
            totalAdded++;
          }
        }
      }else{
        let totalInScope=0;
        for(const fi of frameList){
          const frame=frames[fi];
          const frameData=aviData.bytes.slice(frame.dataOffset,frame.dataOffset+frame.size);
          for(let i=0;i<frameData.length;i++){
            const ao=frame.dataOffset+i;
            if(ao<protectedHeaderEnd)continue;
            const val=frameData[i];
            const inRange=valueRanges.some(r=>val>=r.min&&val<=r.max);
            if(inRange)totalInScope++;
          }
        }
        
        const f=frames[currentFrame];
        for(let i=0;i<hexData.length;i++){
          if(f.dataOffset+i<protectedHeaderEnd)continue;
          if(frameProtectionEnabled&&i<currentFrameProtectionEnd)continue;
          const val=hexData[i];
          const inRange=valueRanges.some(r=>val>=r.min&&val<=r.max);
          if(inRange&&!selectedBytes.has(i)){
            selectedBytes.add(i);
            totalAdded++;
          }
        }
        
        alert(`Added ${totalAdded} bytes in current frame\n${totalInScope} total in scope`);
      }
      
      updateSelectionInfo();
      renderHex();
    }

    function toggleFrameProtection(){
      frameProtectionEnabled=!frameProtectionEnabled;
      updateProtectionBadge();
      loadFrameHex(currentFrame);
    }

    function updateProtectionBadge(){
      const badge=document.getElementById('protectionBadge');
      if(!frameProtectionEnabled){
        badge.className='badge safe';
        badge.textContent='‚ö† Protection OFF';
        badge.title='Click to enable';
      }else if(currentFrameProtectionEnd>0){
        badge.className='badge warn';
        badge.textContent=`‚ö† ${currentFrameProtectionEnd}b`;
        badge.title=`${currentFrameProtectionEnd} bytes protected`;
      }else{
        badge.className='badge warn';
        badge.textContent='‚ö† Protected';
        badge.title='File header protected';
      }
    }

    function renderHex(){
      if(!hexData)return;
      const cont=document.getElementById('hexView');
      cont.innerHTML='';
      const f=frames[currentFrame];
      for(let i=0;i<hexData.length;i+=16){
        const row=document.createElement('div');
        row.className='hex-row';
        const off=document.createElement('span');
        off.className='hex-offset';
        off.textContent=i.toString(16).padStart(8,'0').toUpperCase();
        row.appendChild(off);
        const bd=document.createElement('div');
        bd.className='hex-bytes';
        const rb=hexData.slice(i,Math.min(i+16,hexData.length));
        Array.from(rb).forEach((b,j)=>{
          const ao=f.dataOffset+i+j;
          const relativeOffset=i+j;
          const prot=ao<protectedHeaderEnd||(frameProtectionEnabled&&relativeOffset<currentFrameProtectionEnd);
          const inp=document.createElement('input');
          inp.className='hex-byte';
          if(prot){inp.className+=' hex-byte-protected';inp.disabled=true;}
          inp.value=b.toString(16).padStart(2,'0').toUpperCase();
          inp.maxLength=2;
          inp.dataset.index=i+j;
          if(!prot){
            inp.onclick=e=>{
              const idx=parseInt(inp.dataset.index);
              if(e.shiftKey&&selectedBytes.size>0)selectedBytes.add(idx);
              else if(e.ctrlKey||e.metaKey)selectedBytes.has(idx)?selectedBytes.delete(idx):selectedBytes.add(idx);
              else{selectedBytes.clear();selectedBytes.add(idx);}
              updateSelectionInfo();renderHex();
              const ni=document.querySelector(`input[data-index="${idx}"]`);
              if(ni){ni.focus();ni.select();}
            };
            inp.onchange=()=>editByte(parseInt(inp.dataset.index),inp.value);
            inp.onkeydown=e=>{
              const idx=parseInt(inp.dataset.index);
              let ti=null;
              if(e.key==='ArrowRight'||e.key==='Tab'){e.preventDefault();ti=idx+1;}
              else if(e.key==='ArrowLeft'){e.preventDefault();ti=idx-1;}
              else if(e.key==='ArrowDown'){e.preventDefault();ti=idx+16;}
              else if(e.key==='ArrowUp'){e.preventDefault();ti=idx-16;}
              else if(e.key==='Enter'){e.preventDefault();inp.blur();return;}
              if(ti!==null){
                const t=document.querySelector(`input[data-index="${ti}"]`);
                if(t&&!t.disabled){t.focus();t.select();}
              }
            };
          }
          if(selectedBytes.has(i+j))inp.classList.add('selected');
          bd.appendChild(inp);
        });
        row.appendChild(bd);
        const asc=document.createElement('span');
        asc.className='hex-ascii';
        asc.textContent=Array.from(rb).map(b=>(b>=32&&b<=126)?String.fromCharCode(b):'.').join('');
        row.appendChild(asc);
        cont.appendChild(row);
      }
    }

    function updateFrameInfo(){
      const f=frames[currentFrame];
      if(!f)return;
      const fps=30;
      const totalSeconds=currentFrame/fps;
      const minutes=Math.floor(totalSeconds/60);
      const seconds=Math.floor(totalSeconds%60);
      const milliseconds=Math.floor((totalSeconds%1)*1000);
      const timecode=`${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}:${milliseconds.toString().padStart(3,'0')}`;
      document.getElementById('hexTitle').textContent=`(${currentFrame})`;
      document.getElementById('timeDisplay').textContent=timecode;
      
      let typeLabel='';
      if(f.frameType==='I'){
        typeLabel='<span class="badge i-frame" style="margin-left:6px">I-FRAME</span>';
      }else if(f.frameType==='P'){
        typeLabel='<span class="badge p-frame" style="margin-left:6px">P-FRAME</span>';
      }
      
      let info=`<strong>Frame ${currentFrame}/${frames.length-1}</strong>${typeLabel} ‚Ä¢ ${f.type} ‚Ä¢ ${f.isVideo?'Video':'Audio'}<br>${f.size.toLocaleString()}b ‚Ä¢ 0x${f.dataOffset.toString(16).toUpperCase()}`;
      if(f.dataOffset<protectedHeaderEnd){
        const p=Math.min(f.size,protectedHeaderEnd-f.dataOffset);
        info+=`<br><span class="badge warn" style="margin-top:4px;display:inline-block">File: ${p}b protected</span>`;
      }
      if(currentFrameProtectionEnd>0){
        info+=`<br><span class="badge warn" style="margin-top:4px;display:inline-block">Frame: ${currentFrameProtectionEnd}b protected</span>`;
      }
      document.getElementById('frameInfo').innerHTML=info;
      document.getElementById('stepBackBtn').disabled=currentFrame===0;
      document.getElementById('stepBtn').disabled=currentFrame===frames.length-1;
      drawTimeline();
    }

    function drawTimeline(){
      const c=document.getElementById('timeline');
      if(!c.getContext)return;
      const ctx=c.getContext('2d');
      const r=c.getBoundingClientRect();
      c.width=r.width;
      c.height=70;
      const w=c.width,h=c.height;
      
      const isDark=!html.getAttribute('data-theme');
      const bgColor=isDark?'#000':'#fafafa';
      const labelColor=isDark?'#666':'#999';
      
      ctx.fillStyle=bgColor;
      ctx.fillRect(0,0,w,h);
      
      if(frames.length>0){
        const maxSize=Math.max(...frames.filter(f=>f.isVideo).map(f=>f.size),1);
        frames.forEach((f,i)=>{
          if(!f.isVideo)return;
          const x=(i/frames.length)*w;
          const barWidth=Math.max(1,w/frames.length);
          const barHeight=(f.size/maxSize)*(h-20);
          
          if(f.frameType==='I'){
            ctx.fillStyle='#FF00FF';
          }else{
            ctx.fillStyle='rgba(0,188,212,0.7)';
          }
          ctx.fillRect(x,h-20-barHeight,barWidth,barHeight);
        });
      }
      
      const cx=(currentFrame/Math.max(frames.length-1,1))*w;
      ctx.strokeStyle='#00bcd4';
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.moveTo(cx,0);
      ctx.lineTo(cx,h);
      ctx.stroke();
      ctx.fillStyle='#00bcd4';
      ctx.shadowColor='#00bcd4';
      ctx.shadowBlur=6;
      ctx.beginPath();
      ctx.arc(cx,h-10,5,0,Math.PI*2);
      ctx.fill();
      ctx.shadowBlur=0;
      
      const rt=document.querySelector('input[name="frameRange"]:checked')?.value;
      
      if(selectedBytes.size>0&&hexData){
        if(rt==='current'){
          ctx.fillStyle='rgba(255,0,255,0.3)';
          ctx.fillRect(cx-1,0,3,h-15);
        }else{
          const selectionData=[];
          Array.from(selectedBytes).sort((a,b)=>a-b).forEach(idx=>{
            if(idx<hexData.length){
              selectionData.push({position:idx,value:hexData[idx]});
            }
          });
          
          const occurrences=new Array(frames.length).fill(0);
          for(let fi=0;fi<frames.length;fi++){
            const frame=frames[fi];
            const frameData=aviData.bytes.slice(frame.dataOffset,frame.dataOffset+frame.size);
            let matchCount=0;
            selectionData.forEach(sel=>{
              if(sel.position<frameData.length){
                const ao=frame.dataOffset+sel.position;
                if(ao>=protectedHeaderEnd&&frameData[sel.position]===sel.value){
                  matchCount++;
                }
              }
            });
            occurrences[fi]=matchCount;
          }
          
          const maxOcc=Math.max(...occurrences,1);
          const logMax=Math.log(maxOcc+1);
          
          for(let i=0;i<frames.length;i++){
            if(occurrences[i]>0){
              const x=(i/frames.length)*w;
              const barWidth=Math.max(1,w/frames.length);
              const logValue=Math.log(occurrences[i]+1);
              const barHeight=(logValue/logMax)*(h-20);
              const intensity=occurrences[i]/maxOcc;
              ctx.fillStyle=`rgba(255,0,255,${intensity*0.6})`;
              ctx.fillRect(x,h-20-barHeight,barWidth,barHeight);
            }
          }
          
          ctx.fillStyle=labelColor;
          ctx.font='10px Roboto Mono';
          ctx.textAlign='center';
          ctx.fillText('Max: '+maxOcc+' matches/frame',w/2,12);
        }
      }
      
      if(rt==='custom'){
        const sx=(customRangeStart/frames.length)*w;
        const ex=((customRangeEnd+1)/frames.length)*w;
        ctx.fillStyle='rgba(255,0,255,0.15)';
        ctx.fillRect(sx,0,ex-sx,h);
        ctx.strokeStyle='#FF00FF';
        ctx.lineWidth=2;
        ctx.beginPath();
        ctx.moveTo(sx,0);
        ctx.lineTo(sx,h);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(ex,0);
        ctx.lineTo(ex,h);
        ctx.stroke();
      }else if(rt==='iframes'){
        frames.forEach((f,i)=>{
          if(f.frameType==='I'){
            const x=(i/frames.length)*w;
            const barWidth=Math.max(2,w/frames.length);
            ctx.fillStyle='rgba(255,0,255,0.2)';
            ctx.fillRect(x,0,barWidth,h);
          }
        });
      }else if(rt==='pframes'){
        frames.forEach((f,i)=>{
          if(f.frameType==='P'){
            const x=(i/frames.length)*w;
            const barWidth=Math.max(2,w/frames.length);
            ctx.fillStyle='rgba(0,188,212,0.2)';
            ctx.fillRect(x,0,barWidth,h);
          }
        });
      }
      
      const step=document.querySelector('input[name="frameStep"]:checked')?.value;
      if(step==='nth'&&rt!=='current'){
        const nth=parseInt(document.getElementById('nthFrameInput').value)||2;
        const frameList=getFrameList();
        ctx.fillStyle='rgba(255,0,255,0.2)';
        for(const fi of frameList){
          const x=(fi/frames.length)*w;
          const barWidth=Math.max(2,w/frames.length);
          ctx.fillRect(x,0,barWidth,h);
        }
      }
      
      const fps=30;
      const startTime=0;
      const endTime=(frames.length-1)/fps;
      const formatTime=t=>{
        const m=Math.floor(t/60);
        const s=Math.floor(t%60);
        const ms=Math.floor((t%1)*1000);
        return m.toString().padStart(2,'0')+':'+s.toString().padStart(2,'0')+':'+ms.toString().padStart(3,'0');
      };
      ctx.fillStyle=labelColor;
      ctx.font='10px Roboto Mono';
      ctx.textAlign='left';
      ctx.fillText(formatTime(startTime),2,h-2);
      ctx.textAlign='right';
      ctx.fillText(formatTime(endTime),w-2,h-2);
    }

    document.getElementById('timeline').addEventListener('mousedown',e=>{
      stopPlayback();
      const rt=document.querySelector('input[name="frameRange"]:checked')?.value;
      const r=e.target.getBoundingClientRect();
      const x=e.clientX-r.left;
      const fi=Math.floor((x/r.width)*frames.length);
      if(rt==='custom'){
        const tol=15;
        const sx=(customRangeStart/frames.length)*r.width;
        const ex=((customRangeEnd+1)/frames.length)*r.width;
        if(Math.abs(x-sx)<tol)draggingHandle='start';
        else if(Math.abs(x-ex)<tol)draggingHandle='end';
        else{draggingHandle='end';customRangeStart=fi;customRangeEnd=fi;updateRangeDisplay();drawTimeline();}
      }else if(fi>=0&&fi<frames.length)setFrame(fi);
    });

    document.getElementById('timeline').addEventListener('mousemove',e=>{
      if(!draggingHandle)return;
      const r=e.target.getBoundingClientRect();
      const x=e.clientX-r.left;
      const fi=Math.max(0,Math.min(frames.length-1,Math.floor((x/r.width)*frames.length)));
      if(draggingHandle==='start')customRangeStart=Math.min(fi,customRangeEnd);
      else if(draggingHandle==='end')customRangeEnd=Math.max(fi,customRangeStart);
      updateRangeDisplay();drawTimeline();
    });

    document.addEventListener('mouseup',()=>draggingHandle=null);

    function setFrame(v){
      const nf=parseInt(v);
      if(nf>=0&&nf<frames.length){
        currentFrame=nf;
        document.getElementById('frameInput').value=nf;
        loadFrameHex(nf);
        updateFrameInfo();
        updateFrequencyChart();
      }
    }

    function startPlayback(){
      if(!frames.length)return;
      isPlaying=true;
      document.getElementById('playBtn').textContent='‚ùö‚ùö';
      playbackInterval=setInterval(()=>{
        if(currentFrame<frames.length-1)setFrame(currentFrame+1);
        else stopPlayback();
      },100);
    }

    function stopPlayback(){
      isPlaying=false;
      document.getElementById('playBtn').textContent='‚ñ∂';
      if(playbackInterval){clearInterval(playbackInterval);playbackInterval=null;}
    }

    document.getElementById('playBtn').onclick=()=>isPlaying?stopPlayback():startPlayback();
    document.getElementById('stepBackBtn').onclick=()=>{stopPlayback();setFrame(currentFrame-1);};
    document.getElementById('stepBtn').onclick=()=>{stopPlayback();setFrame(currentFrame+1);};
    document.getElementById('rewindBtn').onclick=()=>{stopPlayback();setFrame(0);};
    document.getElementById('frameInput').onchange=e=>setFrame(e.target.value);

    document.addEventListener('keydown',e=>{
      if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey){e.preventDefault();if(undoStack.length)undo();}
      else if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.shiftKey&&e.key==='z'))){e.preventDefault();if(redoStack.length)redo();}
    });

    function saveState(){
      undoStack.push(new Uint8Array(aviData.bytes));
      if(undoStack.length>50)undoStack.shift();
      redoStack=[];
      document.getElementById('undoBtn').disabled=false;
      document.getElementById('redoBtn').disabled=true;
      updateChangeCount();
    }

    function undo(){
      if(!undoStack.length)return;
      redoStack.push(new Uint8Array(aviData.bytes));
      aviData.bytes=new Uint8Array(undoStack.pop());
      reparseFrames();
      loadFrameHex(currentFrame);
      videoBlob=null;
      document.getElementById('undoBtn').disabled=undoStack.length===0;
      document.getElementById('redoBtn').disabled=false;
      updateChangeCount();
      updateFrequencyChart();
    }

    function redo(){
      if(!redoStack.length)return;
      undoStack.push(new Uint8Array(aviData.bytes));
      aviData.bytes=new Uint8Array(redoStack.pop());
      reparseFrames();
      loadFrameHex(currentFrame);
      videoBlob=null;
      document.getElementById('undoBtn').disabled=false;
      document.getElementById('redoBtn').disabled=redoStack.length===0;
      updateChangeCount();
      updateFrequencyChart();
    }

    document.getElementById('resetBtn').onclick=()=>{
      if(!originalBytes||!confirm('Reset?'))return;
      undoStack=[];
      redoStack=[];
      aviData.bytes=new Uint8Array(originalBytes);
      reparseFrames();
      loadFrameHex(currentFrame);
      videoBlob=null;
      document.getElementById('undoBtn').disabled=true;
      document.getElementById('redoBtn').disabled=true;
      updateChangeCount();
      updateFrequencyChart();
    };

    function updateChangeCount(){
      if(!originalBytes)return;
      let c=0;
      for(let i=0;i<aviData.bytes.length;i++)if(aviData.bytes[i]!==originalBytes[i])c++;
      const el=document.getElementById('changeCount');
      if(c===0){el.textContent='No changes';el.style.color='var(--muted)';}
      else{el.textContent=c.toLocaleString()+' modified';el.style.color='var(--accent)';}
    }

    function editByte(idx,val){
      const v=parseInt(val,16);
      if(isNaN(v)||v<0||v>255)return;
      const f=frames[currentFrame];
      const ao=f.dataOffset+idx;
      if(ao<protectedHeaderEnd){alert('File header protected');renderHex();return;}
      if(frameProtectionEnabled&&idx<currentFrameProtectionEnd){alert('Frame header protected');renderHex();return;}
      saveState();
      hexData[idx]=v;
      aviData.bytes[ao]=v;
      videoBlob=null;
      renderHex();
      updateSelectionStats();
      updateFrequencyChart();
    }

    document.getElementById('downloadBtn').onclick=()=>{
      if(!aviData)return;
      const blob=new Blob([aviData.bytes],{type:'video/x-msvideo'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download=originalFileName.replace(/\.avi$/i,'_modified.avi');
      a.click();
      URL.revokeObjectURL(url);
    };

    function updateSelectionInfo(){
      const c=selectedBytes.size;
      const el=document.getElementById('selectionInfo');
      if(c===0){el.textContent='No selection';el.style.color='var(--muted)';}
      else{el.textContent=c+' byte'+(c!==1?'s':'');el.style.color='var(--accent)';}
      updateSelectionStats();
      drawTimeline();
    }

    function selectColumn(){
      if(!selectedBytes.size)return alert('Select byte first');
      const columns=new Set();
      selectedBytes.forEach(i=>{columns.add(i%16);});
      selectedBytes.clear();
      columns.forEach(col=>{
        for(let i=col;i<hexData.length;i+=16){selectedBytes.add(i);}
      });
      updateSelectionInfo();
      renderHex();
    }

    function selectRow(){
      if(!selectedBytes.size)return alert('Select byte first');
      const rows=new Set();
      selectedBytes.forEach(i=>{rows.add(Math.floor(i/16));});
      selectedBytes.clear();
      rows.forEach(row=>{
        const rowStart=row*16;
        for(let i=rowStart;i<Math.min(rowStart+16,hexData.length);i++){selectedBytes.add(i);}
      });
      updateSelectionInfo();
      renderHex();
    }

    function expandSelection(){
      if(!selectedBytes.size)return alert('Select first');
      const add=new Set();
      selectedBytes.forEach(i=>{
        if(i>0)add.add(i-1);
        if(i<hexData.length-1)add.add(i+1);
        if(i>=16)add.add(i-16);
        if(i+16<hexData.length)add.add(i+16);
      });
      add.forEach(i=>selectedBytes.add(i));
      updateSelectionInfo();
      renderHex();
    }

    function shrinkSelection(){
      if(!selectedBytes.size)return;
      const rem=new Set();
      selectedBytes.forEach(i=>{
        const hasEmpty=(i>0&&!selectedBytes.has(i-1))||(i<hexData.length-1&&!selectedBytes.has(i+1))||(i>=16&&!selectedBytes.has(i-16))||(i+16<hexData.length&&!selectedBytes.has(i+16));
        if(hasEmpty)rem.add(i);
      });
      rem.forEach(i=>selectedBytes.delete(i));
      updateSelectionInfo();
      renderHex();
    }

    function clearSelection(){
      selectedBytes.clear();
      updateSelectionInfo();
      renderHex();
    }

    function findAndSelect(){
      const ft=document.getElementById('findInput').value.trim();
      if(!ft||!hexData)return alert('Enter hex patterns');
      
      const patterns=ft.split(',').map(p=>p.trim()).filter(p=>p.length>0);
      if(patterns.length===0)return alert('Enter at least one pattern');
      
      const rt=document.querySelector('input[name="frameRange"]:checked').value;
      const frameList=getFrameList();
      
      selectedBytes.clear();
      let totalFound=0;
      let framesWithMatches=0;
      
      if(rt==='current'){
        const f=frames[currentFrame];
        patterns.forEach(pattern=>{
          const cleanPattern=pattern.replace(/\s/g,'');
          const fb=cleanPattern.match(/.{1,2}/g)?.map(b=>parseInt(b,16))||[];
          if(fb.some(isNaN))return;
          
          for(let i=0;i<=hexData.length-fb.length;i++){
            if(f.dataOffset+i<protectedHeaderEnd)continue;
            if(frameProtectionEnabled&&i<currentFrameProtectionEnd)continue;
            let m=true;
            for(let j=0;j<fb.length;j++)if(hexData[i+j]!==fb[j]){m=false;break;}
            if(m){
              for(let j=0;j<fb.length;j++)selectedBytes.add(i+j);
              totalFound++;
            }
          }
        });
        if(!selectedBytes.size)alert('Not found in current frame');
      }else{
        for(const fi of frameList){
          const frame=frames[fi];
          const frameData=aviData.bytes.slice(frame.dataOffset,frame.dataOffset+frame.size);
          let frameMatches=0;
          
          patterns.forEach(pattern=>{
            const cleanPattern=pattern.replace(/\s/g,'');
            const fb=cleanPattern.match(/.{1,2}/g)?.map(b=>parseInt(b,16))||[];
            if(fb.some(isNaN))return;
            
            for(let i=0;i<=frameData.length-fb.length;i++){
              const ao=frame.dataOffset+i;
              if(ao<protectedHeaderEnd)continue;
              
              let m=true;
              for(let j=0;j<fb.length;j++){
                if(frameData[i+j]!==fb[j]){m=false;break;}
              }
              if(m){
                frameMatches++;
                totalFound++;
              }
            }
          });
          
          if(frameMatches>0)framesWithMatches++;
        }
        
        const f=frames[currentFrame];
        patterns.forEach(pattern=>{
          const cleanPattern=pattern.replace(/\s/g,'');
          const fb=cleanPattern.match(/.{1,2}/g)?.map(b=>parseInt(b,16))||[];
          if(fb.some(isNaN))return;
          
          for(let i=0;i<=hexData.length-fb.length;i++){
            if(f.dataOffset+i<protectedHeaderEnd)continue;
            if(frameProtectionEnabled&&i<currentFrameProtectionEnd)continue;
            let m=true;
            for(let j=0;j<fb.length;j++)if(hexData[i+j]!==fb[j]){m=false;break;}
            if(m)for(let j=0;j<fb.length;j++)selectedBytes.add(i+j);
          }
        });
        
        if(totalFound===0)alert('Not found in selected scope');
        else alert(`Found ${totalFound} instances across ${framesWithMatches} frames`);
      }
      
      updateSelectionInfo();
      renderHex();
    }

    function getFrameList(){
      const rt=document.querySelector('input[name="frameRange"]:checked').value;
      const step=document.querySelector('input[name="frameStep"]:checked').value;
      const nth=step==='nth'?parseInt(document.getElementById('nthFrameInput').value)||2:1;
      
      if(rt==='current')return[currentFrame];
      else if(rt==='all'){
        const list=[];
        for(let i=0;i<frames.length;i+=nth)list.push(i);
        return list;
      }else if(rt==='custom'){
        const list=[];
        for(let i=customRangeStart;i<=customRangeEnd;i+=nth)list.push(i);
        return list;
      }else if(rt==='iframes'){
        const list=[];
        let count=0;
        for(let i=0;i<frames.length;i++){
          if(frames[i].frameType==='I'){
            if(count%nth===0)list.push(i);
            count++;
          }
        }
        return list;
      }else if(rt==='pframes'){
        const list=[];
        let count=0;
        for(let i=0;i<frames.length;i++){
          if(frames[i].frameType==='P'){
            if(count%nth===0)list.push(i);
            count++;
          }
        }
        return list;
      }
      return[currentFrame];
    }

    function applyAction(fn,name){
      if(!selectedBytes.size)return alert('Select bytes');
      const frameList=getFrameList();
      const rt=document.querySelector('input[name="frameRange"]:checked').value;
      let msg=name+' '+selectedBytes.size+' bytes';
      if(rt==='current')msg+=' in current frame?';
      else msg+=' across '+frameList.length+' frames?';
      if(!confirm(msg))return;
      saveState();
      let mod=0,skip=0;
      if(rt==='current'){
        const f=frames[currentFrame];
        selectedBytes.forEach(i=>{
          const ao=f.dataOffset+i;
          if(ao<protectedHeaderEnd){skip++;return;}
          if(frameProtectionEnabled&&i<currentFrameProtectionEnd){skip++;return;}
          fn(f,i);
          mod++;
        });
      }else{
        const sp=Array.from(selectedBytes).sort((a,b)=>a-b);
        for(const fi of frameList){
          const f=frames[fi];
          let frameProtEnd=0;
          if(frameProtectionEnabled&&f.isVideo){
            const frameData=aviData.bytes.slice(f.dataOffset,f.dataOffset+f.size);
            for(let i=0;i<frameData.length-1;i++){
              if(frameData[i]===0xFF&&frameData[i+1]===0xDA){frameProtEnd=i+2;break;}
            }
          }
          sp.forEach(i=>{
            if(i>=f.size)return;
            const ao=f.dataOffset+i;
            if(ao<protectedHeaderEnd){skip++;return;}
            if(frameProtectionEnabled&&i<frameProtEnd){skip++;return;}
            fn(f,i);
            mod++;
          });
        }
      }
      loadFrameHex(currentFrame);
      videoBlob=null;
      updateFrequencyChart();
      alert(name+': '+mod+(skip?' ('+skip+' skipped)':''));
    }

    function deleteSelection(){
      applyAction((f,i)=>{aviData.bytes[f.dataOffset+i]=0;if(f.index===currentFrame)hexData[i]=0;},'Delete');
    }

    function randomizeSelection(){
      applyAction((f,i)=>{const v=Math.floor(Math.random()*256);aviData.bytes[f.dataOffset+i]=v;if(f.index===currentFrame)hexData[i]=v;},'Randomize');
    }

    function invertSelection(){
      applyAction((f,i)=>{const v=0xFF-aviData.bytes[f.dataOffset+i];aviData.bytes[f.dataOffset+i]=v;if(f.index===currentFrame)hexData[i]=v;},'Invert');
    }

    function setSelectionValue(){
      if(!selectedBytes.size)return alert('Select bytes');
      const vi=document.getElementById('setValueInput').value;
      if(!vi)return alert('Enter hex');
      const v=parseInt(vi,16);
      if(isNaN(v)||v<0||v>255)return alert('Invalid');
      applyAction((f,i)=>{aviData.bytes[f.dataOffset+i]=v;if(f.index===currentFrame)hexData[i]=v;},'Set '+vi);
    }

    function gradientFill(mode){
      if(!selectedBytes.size)return alert('Select bytes');
      const si=document.getElementById('gradStart').value||'00';
      const ei=document.getElementById('gradEnd').value||'FF';
      const sv=parseInt(si,16);
      const ev=parseInt(ei,16);
      if(isNaN(sv)||isNaN(ev))return alert('Invalid');
      
      const frameList=getFrameList();
      const rt=document.querySelector('input[name="frameRange"]:checked').value;
      
      if(mode==='absolute'){
        if(rt==='current')return alert('Absolute gradient requires multiple frames');
        if(!confirm('Gradient '+si+'‚Üí'+ei+' across '+frameList.length+' frames?'))return;
        saveState();
        let mod=0,skip=0;
        
        for(let idx=0;idx<frameList.length;idx++){
          const fi=frameList[idx];
          const f=frames[fi];
          const frameProgress=idx/(frameList.length-1);
          const frameValue=Math.round(sv+(ev-sv)*frameProgress);
          let frameProtEnd=0;
          if(frameProtectionEnabled&&f.isVideo){
            const frameData=aviData.bytes.slice(f.dataOffset,f.dataOffset+f.size);
            for(let i=0;i<frameData.length-1;i++){
              if(frameData[i]===0xFF&&frameData[i+1]===0xDA){frameProtEnd=i+2;break;}
            }
          }
          selectedBytes.forEach(i=>{
            if(i>=f.size)return;
            const ao=f.dataOffset+i;
            if(ao<protectedHeaderEnd){skip++;return;}
            if(frameProtectionEnabled&&i<frameProtEnd){skip++;return;}
            aviData.bytes[ao]=frameValue;
            mod++;
          });
        }
        loadFrameHex(currentFrame);
        videoBlob=null;
        updateFrequencyChart();
        alert('Absolute gradient: '+mod+(skip?' ('+skip+' skipped)':''));
      }else{
        if(!confirm('Gradient '+si+'‚Üí'+ei+(rt!=='current'?' in each frame':'')+'?'))return;
        saveState();
        if(rt==='current'){
          const f=frames[currentFrame];
          const sb=Array.from(selectedBytes).sort((a,b)=>a-b);
          let mod=0,skip=0;
          sb.forEach((i,idx)=>{
            const ao=f.dataOffset+i;
            if(ao<protectedHeaderEnd){skip++;return;}
            if(frameProtectionEnabled&&i<currentFrameProtectionEnd){skip++;return;}
            const p=sb.length>1?idx/(sb.length-1):0;
            const v=Math.round(sv+(ev-sv)*p);
            aviData.bytes[ao]=v;
            hexData[i]=v;
            mod++;
          });
          videoBlob=null;
          renderHex();
          updateSelectionStats();
          updateFrequencyChart();
          alert('Gradient: '+mod+(skip?' ('+skip+' skipped)':''));
        }else{
          const sp=Array.from(selectedBytes).sort((a,b)=>a-b);
          let mod=0,skip=0;
          for(const fi of frameList){
            const f=frames[fi];
            let frameProtEnd=0;
            if(frameProtectionEnabled&&f.isVideo){
              const frameData=aviData.bytes.slice(f.dataOffset,f.dataOffset+f.size);
              for(let i=0;i<frameData.length-1;i++){
                if(frameData[i]===0xFF&&frameData[i+1]===0xDA){frameProtEnd=i+2;break;}
              }
            }
            sp.forEach((i,idx)=>{
              if(i>=f.size)return;
              const ao=f.dataOffset+i;
              if(ao<protectedHeaderEnd){skip++;return;}
              if(frameProtectionEnabled&&i<frameProtEnd){skip++;return;}
              const p=sp.length>1?idx/(sp.length-1):0;
              const v=Math.round(sv+(ev-sv)*p);
              aviData.bytes[ao]=v;
              mod++;
            });
          }
          loadFrameHex(currentFrame);
          videoBlob=null;
          updateFrequencyChart();
          alert('Relative gradient: '+mod+(skip?' ('+skip+' skipped)':''));
        }
      }
    }

    function patternFill(){
      if(!selectedBytes.size)return alert('Select bytes');
      const pi=document.getElementById('patternInput').value.trim();
      if(!pi)return alert('Enter pattern');
      const pat=pi.split(/\s+/).map(v=>parseInt(v,16));
      if(pat.some(isNaN))return alert('Invalid');
      
      const frameList=getFrameList();
      const rt=document.querySelector('input[name="frameRange"]:checked').value;
      let msg='Pattern ['+pi+'] for '+selectedBytes.size+' bytes';
      if(rt==='current')msg+=' in current frame?';
      else msg+=' across '+frameList.length+' frames?';
      if(!confirm(msg))return;
      saveState();
      let mod=0,skip=0;
      if(rt==='current'){
        const f=frames[currentFrame];
        const sb=Array.from(selectedBytes).sort((a,b)=>a-b);
        sb.forEach((i,idx)=>{
          const ao=f.dataOffset+i;
          if(ao<protectedHeaderEnd){skip++;return;}
          if(frameProtectionEnabled&&i<currentFrameProtectionEnd){skip++;return;}
          const v=pat[idx%pat.length];
          aviData.bytes[ao]=v;
          hexData[i]=v;
          mod++;
        });
      }else{
        const sp=Array.from(selectedBytes).sort((a,b)=>a-b);
        for(const fi of frameList){
          const f=frames[fi];
          let frameProtEnd=0;
          if(frameProtectionEnabled&&f.isVideo){
            const frameData=aviData.bytes.slice(f.dataOffset,f.dataOffset+f.size);
            for(let i=0;i<frameData.length-1;i++){
              if(frameData[i]===0xFF&&frameData[i+1]===0xDA){frameProtEnd=i+2;break;}
            }
          }
          sp.forEach((i,idx)=>{
            if(i>=f.size)return;
            const ao=f.dataOffset+i;
            if(ao<protectedHeaderEnd){skip++;return;}
            if(frameProtectionEnabled&&i<frameProtEnd){skip++;return;}
            const v=pat[idx%pat.length];
            aviData.bytes[ao]=v;
            mod++;
          });
        }
      }
      loadFrameHex(currentFrame);
      videoBlob=null;
      updateFrequencyChart();
      alert('Pattern: '+mod+(skip?' ('+skip+' skipped)':''));
    }

    function shiftSelection(dir){
      if(!selectedBytes.size)return alert('Select bytes');
      const sa=parseInt(document.getElementById('shiftAmount').value)||16;
      const as=sa*dir;
      applyAction((f,i)=>{
        const cv=aviData.bytes[f.dataOffset+i];
        const nv=Math.max(0,Math.min(255,cv+as));
        aviData.bytes[f.dataOffset+i]=nv;
        if(f.index===currentFrame)hexData[i]=nv;
      },'Shift '+(dir>0?'+':'')+as);
    }

    function getFrameRange(){
      const rt=document.querySelector('input[name="frameRange"]:checked').value;
      if(rt==='current')return[currentFrame,currentFrame];
      else if(rt==='all')return[0,frames.length-1];
      else if(rt==='custom')return[customRangeStart,customRangeEnd];
      else if(rt==='iframes'){
        const iFrameIndices=frames.map((f,i)=>f.frameType==='I'?i:-1).filter(i=>i>=0);
        if(iFrameIndices.length===0)return[currentFrame,currentFrame];
        return[Math.min(...iFrameIndices),Math.max(...iFrameIndices)];
      }else if(rt==='pframes'){
        const pFrameIndices=frames.map((f,i)=>f.frameType==='P'?i:-1).filter(i=>i>=0);
        if(pFrameIndices.length===0)return[currentFrame,currentFrame];
        return[Math.min(...pFrameIndices),Math.max(...pFrameIndices)];
      }
      return[currentFrame,currentFrame];
    }

    function updateRangeMode(){
      const rt=document.querySelector('input[name="frameRange"]:checked').value;
      document.getElementById('customRangeDisplay').classList.toggle('hidden',rt!=='custom');
      updateFrequencyChart();
      updateSelectionStats();
      drawTimeline();
    }

    function updateRangeDisplay(){
      document.getElementById('rangeStartDisplay').textContent=customRangeStart;
      document.getElementById('rangeEndDisplay').textContent=customRangeEnd;
      updateFrequencyChart();
      updateSelectionStats();
    }

    ['findInput','setValueInput','gradStart','gradEnd','patternInput'].forEach(id=>{
      const el=document.getElementById(id);
      if(el)el.addEventListener('input',function(){this.value=this.value.toUpperCase();});
    });

    // === DATAMOSH OPERATIONS ===
    
    document.getElementById('deleteIFramesBtn').onclick=function(){
      const frameList=getFrameList();
      const rt=document.querySelector('input[name="frameRange"]:checked').value;
      const step=document.querySelector('input[name="frameStep"]:checked').value;
      const nth=step==='nth'?parseInt(document.getElementById('nthFrameInput').value)||2:1;
      
      const iFramesInScope=frameList.filter(fi=>frames[fi]&&frames[fi].frameType==='I');
      
      if(iFramesInScope.length===0)return alert('No I-frames in selected scope');
      
      let scopeDesc='';
      if(rt==='current')scopeDesc='current frame';
      else if(rt==='all')scopeDesc=step==='nth'?`all frames (every ${nth}${nth===2?'nd':nth===3?'rd':'th'})`:'all frames';
      else if(rt==='custom')scopeDesc=`frames ${customRangeStart}-${customRangeEnd}`+(step==='nth'?` (every ${nth}${nth===2?'nd':nth===3?'rd':'th'})`:``);
      else if(rt==='iframes')scopeDesc=step==='nth'?`all I-frames (every ${nth}${nth===2?'nd':nth===3?'rd':'th'})`:'all I-frames';
      else if(rt==='pframes')scopeDesc=step==='nth'?`I-frames within P-frame scope (every ${nth}${nth===2?'nd':nth===3?'rd':'th'})`:'I-frames within P-frame scope';
      
      if(!confirm(`Delete ${iFramesInScope.length} I-frame(s) in ${scopeDesc}?\n\nThis will create pixel drag effect.`))return;
      saveState();
      deleteFrames(iFramesInScope);
      showDatamoshWarning(`Deleted ${iFramesInScope.length} I-frame(s). Pixel drag effect applied.`);
    };
    
    document.getElementById('duplicatePFramesBtn').onclick=function(){
      const frameList=getFrameList();
      const rt=document.querySelector('input[name="frameRange"]:checked').value;
      const step=document.querySelector('input[name="frameStep"]:checked').value;
      const nth=step==='nth'?parseInt(document.getElementById('nthFrameInput').value)||2:1;
      
      const pFramesInScope=frameList.filter(fi=>frames[fi]&&frames[fi].frameType==='P');
      
      if(pFramesInScope.length===0)return alert('No P-frames in selected scope');
      
      let scopeDesc='';
      if(rt==='current')scopeDesc='current frame';
      else if(rt==='all')scopeDesc=step==='nth'?`all frames (every ${nth}${nth===2?'nd':nth===3?'rd':'th'})`:'all frames';
      else if(rt==='custom')scopeDesc=`frames ${customRangeStart}-${customRangeEnd}`+(step==='nth'?` (every ${nth}${nth===2?'nd':nth===3?'rd':'th'})`:``);
      else if(rt==='iframes')scopeDesc=step==='nth'?`P-frames within I-frame scope (every ${nth}${nth===2?'nd':nth===3?'rd':'th'})`:'P-frames within I-frame scope';
      else if(rt==='pframes')scopeDesc=step==='nth'?`all P-frames (every ${nth}${nth===2?'nd':nth===3?'rd':'th'})`:'all P-frames';
      
      if(!confirm(`Duplicate ${pFramesInScope.length} P-frame(s) in ${scopeDesc}?\n\nThis will create bloom/echo effect.`))return;
      saveState();
      duplicateFrames(pFramesInScope);
      showDatamoshWarning(`Duplicated ${pFramesInScope.length} P-frame(s). Bloom effect applied.`);
    };
    
    document.getElementById('deleteCurrentBtn').onclick=function(){
      if(!frames[currentFrame])return;
      const f=frames[currentFrame];
      if(!confirm(`Delete current frame (${currentFrame})?\n\nType: ${f.frameType||'unknown'}`))return;
      saveState();
      deleteFrames([currentFrame]);
      showDatamoshWarning(`Deleted frame ${currentFrame}.`);
    };
    
    function deleteFrames(indices){
      if(indices.length===0)return;
      
      const sortedIndices=[...indices].sort((a,b)=>b-a);
      const newBytes=new Uint8Array(aviData.bytes.length);
      let writePos=0;
      
      for(let i=0;i<protectedHeaderEnd;i++){
        newBytes[writePos++]=aviData.bytes[i];
      }
      
      const indicesToDelete=new Set(sortedIndices);
      frames.forEach((f,i)=>{
        if(indicesToDelete.has(i))return;
        for(let j=0;j<8;j++){
          newBytes[writePos++]=aviData.bytes[f.offset+j];
        }
        for(let j=0;j<f.size;j++){
          newBytes[writePos++]=aviData.bytes[f.dataOffset+j];
        }
        if(f.size%2===1){
          newBytes[writePos++]=0;
        }
      });
      
      const trimmed=new Uint8Array(writePos);
      for(let i=0;i<writePos;i++)trimmed[i]=newBytes[i];
      
      const newFileSize=writePos-8;
      const view=new DataView(trimmed.buffer);
      view.setUint32(4,newFileSize,true);
      
      aviData.bytes=trimmed;
      videoBlob=null;
      
      reparseFrames();
      
      if(currentFrame>=frames.length)currentFrame=frames.length-1;
      if(currentFrame<0)currentFrame=0;
      loadFrameHex(currentFrame);
      updateFrameInfo();
    }
    
    function duplicateFrames(indices){
      if(indices.length===0)return;
      
      const sortedIndices=[...indices].sort((a,b)=>a-b);
      const estimatedSize=aviData.bytes.length+sortedIndices.length*10000;
      const newBytes=new Uint8Array(estimatedSize);
      let writePos=0;
      
      for(let i=0;i<protectedHeaderEnd;i++){
        newBytes[writePos++]=aviData.bytes[i];
      }
      
      const indicesToDuplicate=new Set(sortedIndices);
      frames.forEach((f,i)=>{
        for(let j=0;j<8;j++){
          newBytes[writePos++]=aviData.bytes[f.offset+j];
        }
        for(let j=0;j<f.size;j++){
          newBytes[writePos++]=aviData.bytes[f.dataOffset+j];
        }
        if(f.size%2===1)newBytes[writePos++]=0;
        
        if(indicesToDuplicate.has(i)){
          for(let j=0;j<8;j++){
            newBytes[writePos++]=aviData.bytes[f.offset+j];
          }
          for(let j=0;j<f.size;j++){
            newBytes[writePos++]=aviData.bytes[f.dataOffset+j];
          }
          if(f.size%2===1)newBytes[writePos++]=0;
        }
      });
      
      const trimmed=new Uint8Array(writePos);
      for(let i=0;i<writePos;i++)trimmed[i]=newBytes[i];
      
      const newFileSize=writePos-8;
      const view=new DataView(trimmed.buffer);
      view.setUint32(4,newFileSize,true);
      
      aviData.bytes=trimmed;
      videoBlob=null;
      
      reparseFrames();
      loadFrameHex(currentFrame);
      updateFrameInfo();
    }
    
    function reparseFrames(){
      const bytes=aviData.bytes;
      const view=new DataView(bytes.buffer);
      const foundFrames=[];
      let pos=protectedHeaderEnd;
      let fi=0;
      
      while(pos<bytes.length-8){
        const id=String.fromCharCode(...bytes.slice(pos,pos+4));
        const sz=view.getUint32(pos+4,true);
        if(id.match(/^\d{2}(db|dc|wb)/i)){
          foundFrames.push({
            index:fi++,
            type:id,
            offset:pos,
            dataOffset:pos+8,
            size:sz,
            isVideo:id.toLowerCase().endsWith('db')||id.toLowerCase().endsWith('dc')
          });
        }
        const next=pos+8+sz+(sz%2);
        if(next<=pos||next>bytes.length)break;
        pos=next;
      }
      
      frames=foundFrames;
      aviData.frames=foundFrames;
      
      analyzeFrameTypes();
      
      document.getElementById('frameInput').max=frames.length-1;
      document.getElementById('totalFrames').textContent=frames.length;
      document.getElementById('videoFrames').textContent=frames.filter(f=>f.isVideo).length;
      updateRangeDisplay();
      drawTimeline();
    }
    
    function showDatamoshWarning(msg){
      const el=document.getElementById('datamoshWarning');
      el.textContent=msg;
      el.classList.remove('hidden');
      setTimeout(()=>el.classList.add('hidden'),5000);
    }

    window.addEventListener('resize',()=>{if(frames.length)drawTimeline();});
  </script>
</body>
</html>
